<!DOCTYPE html>
<html>
<head>
    <style>
        #map {
            height: 100%;
        }
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #chart-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 33%;
            height: 100%;
            background: #f0f0f0;
            display: none;
            z-index: 999;
        }
        .charts-container {
            height: calc(100% - 40px); /* Adjust for close button height */
            overflow-y: auto;
            padding: 10px;
        }
        .close {
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="chart-panel">
        <span class="close" onclick="closeChartPanel()"></span>
        <div class="charts-container" id="chartContainer">
            <!-- Charts will be loaded here -->
        </div>
    </div>

    <script>
        var map, infoWindow, chartPanel;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 20.98757293313669, lng: 105.93685697450815 },
                zoom: 15
            });

            // Create a single InfoWindow instance
            infoWindow = new google.maps.InfoWindow();

            // Create a single Chart Panel instance
            chartPanel = new google.maps.InfoWindow({
                maxWidth: 400
            });

            // Create markers
            var locations = [
                { lat: 20.98757293313669, lng: 105.93685697450815 },
                { lat: 20.9885281986878, lng: 105.93641384324708 },
                { lat: 20.989660048349222, lng: 105.936062074998 },
                { lat: 20.990689732556987, lng: 105.9356772327678 }
            ];

            locations.forEach(function(location) {
                var marker = new google.maps.Marker({
                    position: location,
                    map: map
                });

                marker.addListener('click', function() {
                    openChartPanel(location);
                });
            });
        }

        function openChartPanel(location) {
            // Open the chart panel
            chartPanel.setContent(document.getElementById('chart-panel'));
            chartPanel.setPosition(location);
            chartPanel.open(map);

            // Load the chart iframes dynamically
            var chartContainer = document.getElementById('chartContainer');
            var iframeContent = `
                <iframe width="100%" height="260" style="border: 1px solid #cccccc;" src="https://thingspeak.com/channels/2449920/charts/1?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=60&type=line"></iframe>
                <iframe width="100%" height="260" style="border: 1px solid #cccccc;" src="https://thingspeak.com/channels/2449920/charts/2?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=60&type=line&update=15"></iframe>
                <iframe width="100%" height="260" style="border: 1px solid #cccccc;" src="https://thingspeak.com/channels/2449920/charts/3?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=60&type=line&update=15"></iframe>
                <iframe width="100%" height="260" style="border: 1px solid #cccccc;" src="https://thingspeak.com/channels/2449920/charts/4?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=60&type=line&update=15"></iframe>
            `;
            var chartPanel = new google.maps.chartPanel();
            chartPanel.setContent(iframeContent);
            chartPanel.open(map, this);
        }

        function closeChartPanel() {
            chartPanel.close();
        }
    </script>
    
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDl1KFan0b8-CUfVZn1q87FDQNAT61fRKc&callback=initMap">
    </script>
</body>
</html>

<!--

<!DOCTYPE html>
<html>
<head>
    <title>Google Maps Markers</title>
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        var map;
        var markers = [];
        var data;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 20.98757293313669, lng: 105.93685697450815 },
                zoom: 15
            });

            // Fetch data from Google Sheets
            fetch('https://sheets.googleapis.com/v4/spreadsheets/1-rQXU0t33ILZb3maYWHjexXdAcKLVph0ljoGLspnmzQ/values/Sheet1!A1:D?key=')
                .then(response => response.json())
                .then(data => {
                    // Parse data and update markers
                    updateMarkers(data.values);
                });
        }

        function updateMarkers(values) {
            // Remove existing markers
            markers.forEach(marker => {
                marker.setMap(null);
            });
            markers = [];

            // Create new markers
            for (var i = 0; i < values.length; i++) {
                var location = { lat: parseFloat(values[i][0]), lng: parseFloat(values[i][1]) };
                var marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: getMarkerIcon(i)
                });

                // Add event listeners
                marker.addListener('dblclick', function () {
                    handleMarkerDoubleClick(i);
                });

                markers.push(marker);
            }
        }

        function getMarkerIcon(index) {
            var color = (data[index][2] > data[index][3]) ? 'green' : 'yellow';
            return {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 8,
                fillColor: color,
                fillOpacity: 0.6,
                strokeColor: 'black',
                strokeWeight: 1
            };
        }

         // Create markers
        var locations = [
            { lat: 20.98757293313669, lng: 105.93685697450815 },
            { lat: 20.9885281986878, lng: 105.93641384324708 },
            { lat: 20.989660048349222, lng: 105.936062074998 },
            { lat: 20.990689732556987, lng: 105.9356772327678 }
        ];

        for (var i = 0; i < locations.length; i++) {
        var marker = new google.maps.Marker({
            position: locations[i],
            map: map
        });

        // Add click event listener
        marker.addListener('click', function() {
            var iframeContent = `<iframe width="450" height="260" style="border: 1px solid #cccccc;" src="https://thingspeak.com/channels/2449920/charts/${this.getPosition().toString().split('(')[1].split(')')[0]}?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=60&type=line&update=15"></iframe>`;
            var infoWindow = new google.maps.InfoWindow();
            infoWindow.setContent(iframeContent);
            infoWindow.open(map, this);
        });
    }
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDl1KFan0b8-CUfVZn1q87FDQNAT61fRKc&callback=initMap">
    </script>
</body>
</html>
-->